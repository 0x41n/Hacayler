let filein=(t,e)=>{let a=document.createElement("input");a.type="file",a.accept="."+t,a.click(),a.addEventListener("change",()=>{let t=new FileReader;t.onload=(()=>{let a=new DataView(t.result);getDV(a,e)}),t.readAsArrayBuffer(a.files[0])})},fileout=(t,e)=>{let a=document.createElement("a");a.download=t,a.href=e,a.click()},dropin=t=>{t.preventDefault();let[e]=t.dataTransfer.files,a=new FileReader;a.onload=(()=>{let t=new DataView(a.result);getDV(t,0)}),a.readAsArrayBuffer(e)},dragin=t=>{t.preventDefault()},nhd={name:"",type:0,datA:0,datB:0,datC:0,datD:0,ln:0,qb:0},getNHD=t=>{if(2439932004!=t.getUint32(0))return alert("読み込めないファイルです。"),nhd;let e,a=structuredClone(nhd),n=t.getUint8(4);for(a.name="",e=5;e<n+5;e++)a.name+=String.fromCharCode(t.getUint8(e));if(a.type=~~(t.getUint8(n+5)/16),a.datA=~~(t.getUint8(n+5)%16),0==a.type)a.datB=1+~~(t.getUint8(n+6)/16),a.ln=Math.pow(2,a.datB),a.datC=1+~~(t.getUint8(n+6)%16),a.qb=Math.pow(2,a.datC),a.datD=unpak(bf2h(t,n+7,a.ln<pakln(a.ln,a.datC)?a.ln:pakln(a.ln,a.datC)),a.datC,a.ln);else if(1==a.type)for(a.datB=t.getUint8(n+6)+1,a.datD=Array(a.datB).fill().map(()=>[0,128]),e=1;e<a.datB;e++)a.datD[e][0]=t.getUint8(2*e+n+5),a.datD[e][1]=t.getUint8(2*e+n+6);else a.type,a.datB=t.getUint8(n+6)+1;return a},fixNHD=t=>{if(t.name=t.name.replace(/[^ -~]/g,""),t.type=round(t.type,15,0,1),t.datA=round(t.datA,7,0,1),0==t.type){t.datB=round(t.datB,8,1,1),t.ln=Math.pow(2,t.datB);let e=t.datD.length/t.ln;if(1!=e){let a=Array(t.ln);for(let n=0;n<t.ln;n++)a[n]=e>1?t.datD[n*e]:t.datD[~~(n*e)];t.datD=Array().concat(a)}t.datC=round(t.datC,8,1,1),1!=(e=Math.pow(2,t.datC)/t.qb)&&t.datD.forEach((a,n)=>{t.datD[n]=~~((a+1)*e-1)}),t.qb=Math.pow(2,t.datC)}else if(1==t.type){t.ln=256,t.qb=256,t.datB=round(t.datB,256,2,1);let e=t.datD.length;t.datB>e&&(t.datD=t.datD.concat(Array(t.datB-e).fill().map(()=>t.datD[e-1].concat()))),t.datD.length=t.datB,t.datD.forEach((e,a)=>{t.datD[a][0]=round(e[0],a+1<t.datB?t.datD[a+1][0]-1:255,a<1?0:t.datD[a-1][0]+1,1),t.datD[a][1]=round(e[1],255,0,1)})}else 2==t.type?(t.datB=round(t.datB,256,t.datA+1,1),t.ln=t.datB,t.datD=[]):(t.datB=round(t.datB,256,0==t.datA?2:1,1),t.ln=256,t.datD=[]);return structuredClone(t)},makeNHD=t=>{t=fixNHD(t);let e="916E6864"+n2h(t.name.length,2)+s2h(t.name)+n2h(t.type,1)+n2h(t.datA,1);0==t.type?e+=n2h(t.datB-1,1)+n2h(t.datC-1,1):e+=n2h(t.datB-1,2),0==t.type?e+=pak(t.datD,t.datC):1==t.type&&(t.datD.shift(),t.datD.flat(1/0).forEach(t=>{e+=n2h(t,2)}));let a=new Blob([h2bf(e)]);return window.URL.createObjectURL(a)},wvSft=(t,e)=>(t.datD.forEach((a,n)=>{t.datD[n]=round(a+e,t.qb-1,0,1)}),t),wvImg=(t,e,a,n)=>{const d=document.createElement("canvas");d.width=a,d.height=n;const l=d.getContext("2d");if(l.clearRect(0,0,a,n),l.imageSmoothingEnabled=!1,l.strokeStyle=e,l.lineWidth=2,l.beginPath(),0==t.type){let e=a/t.ln,d=n/t.qb,h=0;t.datD.forEach(a=>{l.lineTo(h,(t.qb-.5-a)*d),h+=e,l.lineTo(h,(t.qb-.5-a)*d)})}else if(1==t.type){let e,d;t.datD.forEach(t=>{e=t[0],d=256-t[1],l.lineTo(e*a/256,d*n/256)}),l.lineTo(a,t.datD[0][1]*n/256),hP.value>0&&l.rect(t.datD[hP.value][0]*a/256-3,n-t.datD[hP.value][1]*n/256-3,6,6)}else if(2==t.type){let e=a*t.datA/t.datB;l.lineTo(0,n/8),l.lineTo(e,n/8),l.lineTo(e,7*n/8),l.lineTo(a,7*n/8)}else{let e,d=0==t.datA?65535:16384,h=1;for(e=0;e<256;e++){let r=noise(t,d,h);d=r[0],h=r[1],l.lineTo(e*a/256,3*h*n/4+n/8)}}return l.stroke(),l.getImageData(0,0,a,n)},round=(t,e,a,n)=>Math.round((t>e?e:t<a?a:t)*n)/n,n2h=(t,e)=>{let a=(t=Math.trunc(t<0?t+Math.pow(16,e):t)).toString(16).padStart(e,"0");return e>1?a.match(/.{2}/g).reverse().join(""):a},s2h=t=>{let e="";return t.split("").forEach(t=>{e+=t.charCodeAt().toString(16).padStart(2,"0")}),e},h2bf=t=>{let e=new ArrayBuffer(Math.trunc(t.length/2)),a=new DataView(e);return t.match(/.{2}/g).forEach((t,e)=>{a.setUint8(e,parseInt(t,16))}),e},bf2h=(t,e,a)=>{let n,d="";for(n=0;n<a;n++)d+=t.getUint8(e+n).toString(16).padStart(2,"0");return d},gcd=(t,e)=>e?gcd(e,t%e):t,pak=(t,e)=>{if(t.length<pakln(t.length,e))return dat="",t.forEach(t=>{dat+=n2h(t,2)}),dat;let a,n,d,l=gcd(e,4),h=[];for(n=0;n<t.length;n+=4/l){for(a="",d=0;d<4/l;d++)a+=(void 0===t[n+d]?"":t[n+d].toString(2)).padStart(e,"0");a.match(/.{4}/g).forEach(t=>{h.push(parseInt(t,2).toString(16))})}return h.join("")+"0"},unpak=(t,e,a)=>{if(a<pakln(a,e))return(t=t.match(/.{2}/g)).forEach((e,a)=>{t[a]=parseInt(e,16)}),t;let n=[],d="",l=`.{${e}}`;return l=new RegExp(l,"g"),(t=t.match(/.{1}/g)).forEach(t=>{d+=parseInt(t,16).toString(2).padStart(4,"0")}),(d=d.match(l)).forEach(t=>n.push(parseInt(t,2))),n.slice(0,a)},pakln=(t,e)=>{let a=gcd(e,4);return Math.ceil(t*a/4)*e/(2*a)},coord=(t,e)=>{let a=0;return t.datD.forEach((t,n)=>{a=t[0]>e?a:n}),a},noise=(t,e,a)=>(0==t.datA?a=Math.floor(Math.random()*t.datB)/(t.datB-1):1==t.datA?(0==e&&(e=1),e%=65536,a^=1&(e+=e+(1&(e>>(1&t.datB?6:14)^e>>(1&t.datB?5:13))))):2==t.datA&&(e%=32768,e>>=1,a=1&(e|=(1&(e^e>>(1&t.datB?6:1)))<<14)),[e,a]),ptone=t=>{};const wav={ch:0,bps:8,rate:44100,vol:50,sec:5,key:60,tail:0,spd:0,d:0,rg:0,out:0};let nhd2WAV=t=>{0==(nhd=fixNHD(t)).type?wav.d=(nhd.qb-1)/2:2==nhd.type?(wav.d=1,wav.rg=1):15==t.type&&(nhd.ln=256,wav.d=0,wav.rg=0==nhd.datA?65535:16384,wav.out=1);let e=440*Math.pow(2,(wav.key-69)/12);wav.spd=e/(wav.rate/nhd.ln);let a=~~(wav.bps/8),n=wav.rate*wav.sec,d=wav.rate/e;1==wav.tail?n=d*~~(n/d):2==wav.tail?n=d:3==wav.tail&&(wav.spd=1,n=nhd.ln,wav.ch=0);let l=[],h="";for(let t=0;t<n;t++)wav.ch<1?l.push(calcWav(t)):(l.push((1&wav.ch)>0?calcWav(t):0),l.push((2&wav.ch)>0?calcWav(t):0));let r=wav.ch<1?1:2;n*=a,l.forEach(t=>{h+=n2h(a>1?t*Math.pow(16,a):t+128,2*a)});let o=s2h("RIFF")+n2h(n+36,8)+s2h("WAVE")+s2h("fmt ")+n2h(16,8)+n2h(1,4)+n2h(r,4)+n2h(wav.rate,8)+n2h(wav.rate*r*a,8)+n2h(r*a,4)+n2h(wav.bps,4)+s2h("data")+n2h(n,8);var i=new Blob([h2bf(o+h)]);return window.URL.createObjectURL(i)},calcWav=t=>{if(t*=wav.spd,0==nhd.type)return wav.vol*(interp(t)/nhd.qb)-.5;if(1==nhd.type){let e,a,n,d,l;return e=coord(nhd,t%nhd.ln),n=nhd.datD[e][1],d=nhd.datD[(e+1)%nhd.datB][1],a=0!=(a=nhd.datD[(e+1)%nhd.datB][0])?a:nhd.ln,e=nhd.datD[e][0],l=(t%nhd.ln-e)/(a-e),wav.vol*(n+l*(d-n)-128)/256}if(2==nhd.type){if(0==nhd.datA){wav.d+=1;let e=wav.d/nhd.ln%(2*nhd.ln);return wav.vol*(e>nhd.ln?-1:1)*(t%nhd.ln<e%nhd.ln?1:-1)/2}return wav.vol*(t%nhd.ln<nhd.datA?1:-1)/2}for(let e=0;e<~~(~~t-wav.d);e++){let t=noise(nhd,wav.rg,wav.out);wav.rg=t[0],wav.out=t[1]}return wav.d=~~t,(wav.out-.5)*wav.vol},interp=t=>{if(1==nhd.datA){let e=t%1,a=nhd.datD[~~(t%nhd.ln)];return a+e*(nhd.datD[~~((t+1)%nhd.ln)]-a)}return nhd.datD[~~(t%nhd.ln)]};const kbd=document.createElement("audio");let keybd=()=>{let t='<table style="border-collapse:collapse;cursor:pointer;table-layout:fixed;width:100%;"><tr>';for(let e=0;e<6;e++)for(let e=0;e<12;e++)t+=`<td style='border:solid 1.5px var(--c7);height:1em;background:var(--c${[1,3,6,8,10].includes(e)?6:0})'onmousedown='view(this)'></td>`;roll.innerHTML=t+"</tr></table>"};keybd();let keyup=()=>{kbd.pause(),keybd()},view=t=>{let e=t.cellIndex+24;t.style.background="#9c9e9b",wav.ch=0,wav.bps=8,wav.key=e,wav.sec=1,wav.rate=44100,wav.tail=0,wav.vol=40,kbd.src=nhd2WAV(nhd),kbd.play()},getDV=(t,e)=>{if(0==e)return nhd=getNHD(t),pType(nhd),void toHTML(nhd);hlay.getContext("2d").putImageData(wvImg(getNHD(t),"#878988",512,256),0,0)};const pSel={typ:[["Table",0],["Coord",1],["Pulse",2],["Noise",15]],erp:[["None",0],["Lerp",1]],noi:[["Normal",0],["GBish",1],["FCish",2]],smp:[["8000 Hz",8e3],["11025 Hz",11025],["22050 Hz",22050],["32000 Hz",32e3],["44100 Hz",44100],["48000 Hz",48e3]],ch:[["モノラル",0],["ステレオ",3],["左のみ",1],["右のみ",2]],bit:[["8 bit",8],["16 bit",16]],len:[["秒数ピッタリ",0],["周期ピッタリ",1],["1周期だけ",2],["必要最低限",3]],num:[["10進数",0],["16進数",1]]};let cSel=(t,e,a)=>{let n=""==t?"":`<select id=${t}>`;return e.forEach(t=>{n+=`<option value="${t[1]}"${t[1]==a?"selected":""}>${t[0]}</option>`}),n+(""==t?"":"</select>")};htype.innerHTML=cSel("",pSel.typ,0);let toJS=()=>{nhd.name=hname.value,nhd.type=htype.value,nhd.datA=hA.value,nhd.datB=hB.value,nhd.datC=hC.value,nhd=fixNHD(nhd),toHTML(nhd)},toHTML=t=>{hname.value=t.name,htype.value=t.type,hA.value=t.datA,hB.value=t.datB,hC.value=t.datC,pWave(t)},pType=t=>{let e,a,n,d="";0==t.type?(e=`interp:${cSel("hA",pSel.erp,0)} `,a="sample:<input type='number'class='num'value='5'id='hB'> ",n="bit:<input type='number'class='num'value='4'id='hC'>",d="<input type='button'onclick='shift(1)'value='▲'> <input type='button'onclick='shift(-1)'value='▼'><br>sample:　サンプル数、横軸の長さ<br>bit:　量子化ビット数、縦軸の長さ<br>interp:　補間形式、波形が滑らかになる"):1==t.type?(e="points <input type='number'class='num'id='hB'value='3'onchange=\"hP.value=round(hP.value,this.value-1,1,1)\"> ",a="<input type='number'id='hA'disabled> ",n="<input type='number'id='hC'disabled>",d="うごかす点 <input type='number'id='hP'value='1'onchange='point(0)'><br>X: <input type='number'id='hX'onchange='point(1)'value='63'> Y: <input type='number'id='hY'onchange='point(1)'value='255'><br><br>points:　点の数、最初の点は固定"):2==t.type?(e="dutyH:<input type='number'id='hA'value='1'> ",a="dutyH+L:<input type='number'id='hB'value='2'> ",n="<input type='number'id='hC'disabled>",d="dutyH:　値が高い部分 (左側) の長さ<br>dutyH+L:　全体の長さ<br><br>dutyHが0だと変な音になる<br>dutyH+Lの値で速度調整"):(e=`spec:${cSel("hA",pSel.noi,0)} `,a="para:<input type='number'id='hB'value='0'> ",n="<input type='number'id='hC'disabled>"),hopt.innerHTML=e+a+n,hadd.innerHTML=d},shift=t=>{nhd=wvSft(nhd,t),pWave(nhd)},point=t=>{if(0==t)return hP.value=round(hP.value,nhd.datB-1,1,1),hX.value=nhd.datD[hP.value][0],void(hY.value=nhd.datD[hP.value][1]);nhd.datD[hP.value][0]=hX.value,nhd.datD[hP.value][1]=hY.value,nhd=fixNHD(nhd)},btn=0;window.addEventListener("mousedown",t=>{btn=t.buttons}),window.addEventListener("mouseup",()=>{btn=0,keyup()}),hD.onmousemove=(t=>{msMov(t)}),hD.onmousedown=(t=>{msMov(t)});let msMov=t=>{if(nhd.type>1)return;if(0==btn)return;let e=t.currentTarget.getBoundingClientRect(),a=Math.trunc((t.clientX-e.left)/(t.currentTarget.clientWidth/nhd.ln)),n=Math.trunc(nhd.qb-(t.clientY-e.top)/(t.currentTarget.clientHeight/nhd.qb));0==nhd.type?(n=n>=nhd.qb?nhd.qb-1:n,nhd.datD[a]=1==btn?n:nhd.datD[a]):1==nhd.type&&(nhd.datD[hP.value][0]=round(a,a,nhd.datD[hP.value-1][0]+1,1),nhd.datD[hP.value][1]=n,nhd=fixNHD(nhd),hX.value=nhd.datD[hP.value][0],hY.value=nhd.datD[hP.value][1]),pWave(nhd)},pWave=t=>{hD.getContext("2d").putImageData(wvImg(t,"#00F080",512,256),0,0)};window.addEventListener("dragover",t=>dragin(t)),window.addEventListener("drop",t=>dropin(t));const SVG="data:image/svg+xml;charset=utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#141E32"><path d="M3 4v17h6v-12h6v12h6v-16a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2M4.5 16.5h3v3h-3v-3M16.5 16.5h3v3h-3v-3"/><style>@media(prefers-color-scheme:dark){path{fill:#BBB;}}</style></svg>');fav.href=SVG;let initNHD=t=>{q=structuredClone(nhd),q.type=t,0==t?(q.datD=[11,15,14,14,15,14,10,7,9,13,15,9,3,1,1,5,10,13,14,12,6,0,2,6,8,5,2,0,1,1,0,3],q.datA=0,q.datB=5,q.datC=4,q.ln=32,q.qb=16):1==t?(q.datB=3,q.datD=[[0,128],[63,255],[191,0]]):2==t?(q.datA=1,q.datB=2):(q.datA=0,q.datB=2),nhd=q,pType(q)};initNHD(0),pWave(nhd);