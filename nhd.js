const fIn=(t,h)=>{let i=document.createElement("input"),e,n;i.type="file",i.accept="."+t,i.click(),i.addEventListener("change",t=>{(e=new FileReader).onload=t=>{n=new DataView(e.result),getDV(n,h)},e.readAsArrayBuffer(i.files[0])})},fOut=(t,h)=>{var i=document.createElement("a");i.download=t,i.href=h,i.click()},drop=t=>{t.preventDefault();let[h]=t.dataTransfer.files,i=new FileReader,e;i.onload=t=>{e=new DataView(i.result),getDV(e)},i.readAsArrayBuffer(h)},drag=t=>{t.preventDefault()},int=(t,h=t,i=t)=>Math.round(h<t?h:t<i?i:t),s2a=(t,h=1)=>t.match(new RegExp(`.{${h}}`,"g")),sar=(t,e)=>t.flatMap((t,h,i)=>h%e?[]:[i.slice(h,h+e)]),rpA=(t,h,i)=>t.replace(new RegExp(h,"g"),i),rnd=t=>Math.floor(Math.random()*t),pad=(t,h=2,i=16)=>t.toString(i).padStart(h,"0"),n2h=(t,h)=>{t=pad(Math.trunc(t<0?t+16**h:t),h);return 1<h?t.match(/.{2}/g).reverse().join(""):t},s2h=t=>t.split("").map(t=>pad(t.charCodeAt())).join(""),h2bf=t=>{var h=new ArrayBuffer(Math.trunc(t.length/2));let i=new DataView(h);return t.match(/.{2}/g).forEach((t,h)=>i.setUint8(h,parseInt(t,16))),h},bf2h=(t,h,i)=>{let e="",n;for(n=0;n<i;n++)e+=pad(t.getUint8(h+n));return e},gcd=(t,h)=>h?gcd(h,t%h):t,pak=(t,h)=>{let i="",e=[],n=t.concat().flat(1/0);return n.forEach(t=>i+=pad(t,h,2)),i.length%4&&(i+=pad(0,i.length%4)),s2a(i,4).forEach(t=>e.push(parseInt(t,2).toString(16))),e.join("")+(e.length%2?"0":"")},unpak=(t,h)=>{let i=[],e="";return s2a(t).forEach(t=>e+=pad(parseInt(t,16),4,2)),s2a(e,h).forEach(t=>i.push(parseInt(t,2))),i};class Nhd{constructor(){this.name="SampleWave",this.type=0,this.a=0,this.b=0,this.c=0,this.d=0,this.ln=0,this.qb=0,this.tmp,this.edt,this.ini(0)}ini(t){this.type=t,(this.c=0)==t?(this.d=[11,15,14,14,15,14,10,7,9,13,15,9,3,1,1,5,10,13,14,12,6,0,2,6,8,5,2,0,1,1,0,3],this.a=0,this.b=5,this.c=4,this.ln=32,this.qb=16):1==t?(this.a=8,this.b=2,this.c=256,this.d=[[63,255],[191,0]],this.ln=256,this.qb=256):2==t?(this.a=1,this.b=2,this.d=[...Array(2)].map((t,h)=>h-1)):3==t?(this.a=1,this.b=1,this.c=8,this.qb=0,this.d=[0,3,16,8],this.ln=256):(this.a=0,this.b=4,this.ln=32767,this.d=npr(4))}set(i){if(2439932004!=i.getUint32(0))alert("not NHD"),this.ini(0);else{let t=i.getUint8(4),h;for(this.name="",h=5;h<t+5;h++)this.name+=String.fromCharCode(i.getUint8(h));this.type=~~(i.getUint8(t+5)/16),this.a=~~(i.getUint8(t+5)%16),this.ver(),0==this.type?(this.b=1+~~(i.getUint8(t+6)/16),this.ln=2**this.b,this.c=i.getUint8(t+6)%16+1,this.qb=2**this.c,this.d=unpak(bf2h(i,t+7,i.byteLength-t-7),this.c),this.d.length=this.ln):1==this.type?(this.ln=2**this.a,this.qb=this.ln,this.b=i.getUint8(t+6),this.d=unpak(bf2h(i,t+7,i.byteLength-t-7),this.a),this.d=sar(this.d,2),this.d.length=this.b):3==this.type?(this.b=~~(i.getUint8(t+6)/16),this.qb=~~(this.b/8),this.b=this.b%8,this.c=i.getUint8(t+6)%16+1,this.ln=[i.getUint8(t+7),i.getUint8(t+8)],this.d=[~~(this.ln[0]/16),this.ln[0]%16+1,1+~~(this.ln[1]/16),this.ln[1]%16]):this.b=i.getUint8(t+6),this.fix()}}fix(){if(this.name=this.name.replace(/[^ -~]/g,"").substring(0,256),this.type=int(this.type,15,0),0==this.type){this.a=int(this.a,7,0),this.b=int(this.b,8,2),this.ln=2**this.b;let i=this.d.length/this.ln;if(1!=i){let t=Array(this.ln),h;for(h=0;h<this.ln;h++)t[h]=1<i?this.d[h*i]:this.d[~~(h*i)];this.d=Array().concat(t)}this.c=int(this.c,8,2),1!=(i=2**this.c/this.qb)&&this.d.forEach((t,h)=>this.d[h]=~~((t+1)*i-1)),this.qb=2**this.c}else if(1==this.type){this.a=int(this.a,8,2),this.b=int(this.b,256,1),this.ln=2**this.a;let i=this.ln/this.qb,h=(1!=i&&this.d.forEach((t,h)=>this.d[h]=[~~(t[0]*i),~~(t[1]*i)]),this.qb=this.ln,this.d.length);this.b>h&&(this.d=this.d.concat([...Array(this.b-h)].map(t=>this.d[h-1].concat()))),this.d.length=this.b,this.d.forEach((t,h)=>{this.d[h][0]=int(t[0],h+1>=this.b?this.ln-1:this.d[h+1][0],h<1?0:this.d[h-1][0]),this.d[h][1]=int(t[1],this.ln-1,0)})}else{var t,h;2==this.type?(this.a=int(this.a,15,0),this.b=int(this.b,256,this.a+1),this.ln=this.b):3==this.type?(this.a=int(this.a,7,0),this.b=int(this.b,7,0),this.c=int(this.c,16,1),this.d=[int(this.d[0],15,0),int(this.d[1],16,1),int(this.d[2],16,1),int(this.d[3],16,1)],this.edt=[nFM(OSC[this.a],this.a,1,this.d[0],1)],this.ln=256):(this.b=int(this.b,256,0==this.a?2:1),t=this.a,h=this.b,this.d=3==t?nvc():(1==t?ngb:2==t?nfc:npr)(h),this.ln=this.d.length,this.qb=3==t?128:0<t?2:h)}}sft(h){2&h&&1&h?this.d.unshift(this.d.pop()):2&h?this.d.push(this.d.shift()):this.d=this.d.map(t=>int(t+(1&h?-1:1),this.qb-1,0))}img(t,d,l){let h=document.createElement("canvas"),r;if(h.width=d,h.height=l,(r=h.getContext("2d")).clearRect(0,0,d,l),r.imageSmoothingEnabled=!1,r.strokeStyle=t,r.lineWidth=2,r.beginPath(),0==this.type){let h=d/this.ln,i=l/this.qb,e=0;this.d.forEach(t=>{r.lineTo(e,(this.qb-.5-t)*i),e+=h,r.lineTo(e,(this.qb-.5-t)*i)})}else if(1==this.type){r.moveTo(0,l/2);let h=this.ln,i=h-1;this.d.forEach(t=>r.lineTo(t[0]*d/h,(i-t[1])*l/i)),r.lineTo(d,l/2),this.edt&&r.rect(this.d[this.edt-1][0]*d/h-3,l-this.d[this.edt-1][1]*l/i-3,6,6)}else if(2==this.type){t=d*this.a/this.b;r.lineTo(0,l/8),r.lineTo(t,l/8),r.lineTo(t,7*l/8),r.lineTo(d,7*l/8)}else if(3==this.type){let t,i=d/256,e=l/768,h=e*(this.qb?-1:1)*this.c/16,n=l/12+(16-this.d[3])*l/48,s=3*l/4,a=l/640;for(this.edt[0].forEach((t,h)=>r.lineTo(h*i/3,l/4-t*e)),r.moveTo(d/3,l/4-OSC[this.b][0]*h),t=0;t<256;t++)r.lineTo((t*i+d)/3,l/4-OSC[this.b][t*this.d[1]%256]*h);r.moveTo(2*d/3,l/12),r.lineTo((2+this.d[2]/20)*d/3,n),r.lineTo(d,n),this.tmp=nFM(this.edt[0],this.b,this.d[1],this.c,this.qb),r.moveTo(0,s-a*this.tmp[0]),this.tmp.forEach((t,h)=>r.lineTo(h*i,s-a*t))}else for(let t=0;t<256;t++)r.lineTo(t*d/256,(this.qb-.5-this.d[~~t%this.d.length])*l/this.qb);return r.stroke(),r.getImageData(0,0,d,l)}blb(){this.fix();let t="916E6864"+n2h([...this.name].length,2)+s2h(this.name)+n2h(this.type,1)+n2h(this.a,1);return 0==this.type?t+=n2h(this.b-1,1)+n2h(this.c-1,1)+pak(this.d,this.c):3==this.type?t+=n2h(8*this.qb+this.b,1)+n2h(this.c-1,1)+n2h(this.d[0],1)+n2h(this.d[1]-1,1)+n2h(this.d[2]-1,1)+n2h(this.d[3]-1,1):t+=n2h(this.b,2),1==this.type&&(t+=pak(this.d,this.a)),window.URL.createObjectURL(new Blob([h2bf(t)]))}wav(t,h,i,e,n,s,a){this.fix(),this.frm(i),s-=256<this.ln?96:0;let d,l=1==this.type?256:this.ln,r=[],o="",p=k2f(s),c=~~(h/8),u=i*n,b=p*l/i,f=i/p;for(1==a?u=f*~~(u/f):2==a?u=f:3==a&&(b=1,u=this.ln,t=0),d=0;d<u;d++)t<1?r.push(~~e*this.clc(d*b)):(r.push(1&t?~~e*this.clc(d*b):0),r.push(2&t?~~e*this.clc(d*b):0));t=t<1?1:2,u*=c,r.forEach(t=>o+=1<c?n2h(t*16**c,2*c):n2h(t+128,2*c));s="52494646"+n2h(u+36,8)+"57415645666D7420"+n2h(16,8)+n2h(1,4)+n2h(t,4)+n2h(i,8)+n2h(i*t*c,8)+n2h(t*c,4)+n2h(h,4)+"64617461"+n2h(u*t,8),n=new Blob([h2bf(s+o)]);return window.URL.createObjectURL(n)}clc(t){var h,i,e;return 0==this.type?(1==this.a?lerp(t,this.d):this.d[~~(t%this.ln)])/(this.qb-1)-.5:1==this.type?this.tmp[~~t%256]/255-.5:2==this.type?0==this.a?(h=2*this.ln,this.tmp+=1/h,this.tmp%=2*h,i=this.tmp%h,e=this.tmp>h?1:-1,(2*t%h<i?e:-e)/2):(t%this.ln<this.a?1:-1)/2:3==this.type?(h=this.edt[1].length,this.tmp=int(this.tmp+1,h-1),i=this.edt[1][~~this.tmp%h],e=OSC[this.b][~~(t*this.d[1])%256]*(this.qb?-1:1)*this.c*i/256,this.edt[0][~~(256+t+e)%256]/256):this.d[~~(t%this.ln)]/(this.qb-1)-.5}ver(){1==this.type&&this.a<2&&(this.a=8)}frm(t=0){if(1==this.type){this.tmp=[];let h=255/(this.ln-1),i=256/this.ln;this.d.forEach(t=>this.tmp.push([int(t[0]*i),int(t[1]*h)])),this.tmp=coord([[0,127.5]].concat(this.tmp,[[256,127.5]]))}else 3==this.type?(this.tmp=0,this.edt[1]=coord([[0,16]].concat([[this.d[2]*t/16,this.d[3]]],[[t,this.d[3]]]))):this.tmp=0}}const k2f=t=>440*2**((t-69)/12),knm=t=>s2a("C C#D D#E F F#G G#A A#B ",2)[~~t%12]+~~(t/12),nfc=t=>{let h=[],i=rnd(16384),e;for(e=0;e<(t%2?93:32767);e++)i=(i>>=1)|(1&(i^i>>(t%2?6:1)))<<15,out=1&i,h.push(out);return h},ngb=t=>{let h=65535,i=1,e=[],n;for(n=0;n<(t%2?127:32767);n++)h=0==(h%=65536)?1:h,h+=h+(1&(h>>(t%2?6:14)^h>>(t%2?5:13))),i^=1&h,e.push(i);return e},nvc=t=>{let h=0,i=[],e,n;for(e=0;e<256;e++)n=(h=Math.imul(h,214013)+2531011>>>0)>>16&32767,i.push(~~(n<<24>>24));return i},npr=h=>[...Array(32767)].map(t=>rnd(h)),nhd=(coord=i=>{let e=[],n,s;for(n=0;n<i.length-1;n++){let t=i[n][1],h=(i[n+1][1]-i[n][1])/(i[n+1][0]-i[n][0]);for(s=i[n][0];s<i[n+1][0];s++)e.push(t),t+=h}return e},lerp=(t,h)=>{var i=h[~~(t%h.length)];return i+t%1*(h[~~((t+1)%h.length)]-i)},OSC=[[...Array(256)].fill(0),[...Array(256)].map((t,h)=>~~(128*Math.sin(2*Math.fround(Math.PI)*h/256))),[...Array(256)].map((t,h)=>~~(128-h)),[...Array(256)].map((t,h)=>h<64?2*h:h<192?256-2*h:2*h-512),[...Array(256)].map((t,h)=>h<128?128:-128),[...Array(256)].map((t,h)=>~~((128<h?-128:128)*Math.sin(2*Math.fround(Math.PI)*h/256))),nvc()],nFM=(t,h,i,e,n)=>{let s,a=[];for(s=0;s<256;s++)a.push(t[(h?~~(s+256+(n?-1:1)*OSC[h][s*i%256]*e/16):s)%256]);return a},new Nhd),lay=new Nhd,kbd=document.createElement("audio"),keybd=t=>{let h,i,e='<table style="border-collapse:collapse;cursor:pointer;table-layout:fixed;width:100%"><tr>';for(i=0;i<6;i++)for(h=0;h<12;h++)e+=`<td style='border:solid 1.5px var(--c7);height:1.2em;background:var(--c${[1,3,6,8,10].includes(h)?6:0})'onmousedown='view(this)'></td>`;roll.innerHTML=e+"</tr></table>"},keyup=t=>{kbd.pause(),keybd()},view=t=>{var h=t.cellIndex+24;t.style.background="#9c9e9b",kbd.src=nhd.wav(0,8,44100,40,1,h,0),kbd.play()},pre=t=>{kbd.src=nhd.wav(hch.value,hbit.value,hrate.value,hvol.value,hsec.value,hkey.value,htail.value),kbd.play()},getDV=(t,h)=>{h?(lay.set(t),hlay.getContext("2d").putImageData(lay.img("#878988",512,256),0,0)):(nhd.set(t),fABC()),toHTML()},sel=t=>{let h="";return t.forEach(t=>h+=`<option value="${t[1]}">${t[0]}</option>`),h},toJS=t=>{nhd.name=hname.value,nhd.type=htype.value,nhd.a=hA.value,nhd.b=hB.value,nhd.c=hC.value,toHTML()},toHTML=t=>{nhd.fix(),hname.value=nhd.name,htype.value=nhd.type,hA.value=nhd.a,hB.value=nhd.b,hC.value=nhd.c,3==nhd.type&&(hR.checked=Boolean(nhd.qb),hFB.value=nhd.d[0],hM.value=nhd.d[1],hD2.value=nhd.d[2],hD3.value=nhd.d[3]),point(),pwv(),knam.innerText=knm(hkey.value)},pwv=t=>hDi.getContext("2d").putImageData(nhd.img("#00F080",512,256),0,0),sft=t=>{nhd.sft(t),toHTML()},point=t=>{1==nhd.type&&(t?(nhd.d[hP.value-1][0]=hX.value,nhd.d[hP.value-1][1]=hY.value,nhd.fix(),point(0)):(hP.value=int(hP.value,nhd.b,1),hX.value=nhd.d[hP.value-1][0],hY.value=nhd.d[hP.value-1][1],nhd.edt=hP.value))},fABC=t=>{var h=nhd.type;Ain.innerHTML='<input type="number"id="hA">',Bin.innerHTML='<input type="number"id="hB">',Ctx.innerHTML="-",0==h?(Atx.innerHTML="補間",Ain.innerHTML=`<select id="hA">${sel([["None",0],["Lerp",1]])}</select>`,Btx.innerHTML="よこ",Ctx.innerHTML="たて",Add.innerHTML="<input type='button'onclick='sft(2)'value='<'> <input type='button'onclick='sft(0)'value='▲'> <input type='button'onclick='sft(1)'value='▼'> <input type='button'onclick='sft(3)'value='>'>"):1==h?(Atx.innerHTML="ビット",Btx.innerHTML="座標数",Add.innerHTML=`うごかす点 <input type='number'id='hP'value='1'onchange='point(0)'>　X<input type='number'id='hX'onchange='point(1)'value='${nhd.d[0][0]}'> Y<input type='number'id='hY'onchange='point(1)'value='${nhd.d[0][1]}'>`):2==h?(Atx.innerHTML="H",Btx.innerHTML="T",Add.innerHTML="Duty比 H/T　H0で変な音(T>35がオススメ)"):3==h?(h=sel([["None",0],["Sine",1],["Saw",2],["Triangle",3],["Square",4],["Camel",5],["Noise",6]]),Atx.innerHTML="C",Ain.innerHTML=`<select id="hA">${h}</select>`,Btx.innerHTML='M <input type="checkbox"id="hR"onchange="nhd.qb=Number(this.checked)">',Bin.innerHTML=`<select id="hB">${h}</select>`,Ctx.innerHTML="M音量",Add.innerHTML='CFB <input type="number"id="hFB"onchange="nhd.d[0]=this.value"> M回 <input type="number"id="hM"onchange="nhd.d[1]=this.value">　A時 <input type="number"id="hD2"onchange="nhd.d[2]=this.value"> A音量 <input type="number"id="hD3"onchange="nhd.d[3]=this.value"> '):(Atx.innerHTML="タイプ",Ain.innerHTML=`<select id="hA">${sel([["Rnd",0],["GB",1],["FC",2]])}</select>`,Btx.innerHTML="ぱらめ",Add.innerHTML="ぱらめをいじると音が変わったりする"),toHTML()},msMov=e=>{if(!(1<nhd.type)&&btn){let t=e.currentTarget.getBoundingClientRect(),h=Math.trunc((e.clientX-t.left)/(e.currentTarget.clientWidth/nhd.ln)),i=Math.trunc(nhd.qb-(e.clientY-t.top)/(e.currentTarget.clientHeight/nhd.qb));0==nhd.type?(i=i>=nhd.qb?nhd.qb-1:i,nhd.d[h]=1==btn?i:nhd.d[h]):1==nhd.type&&(e=hP.value-1,nhd.d[e][0]=int(h,h,0<e?nhd.d[e-1][0]:0),nhd.d[e][1]=i,nhd.fix(),hX.value=nhd.d[e][0],hY.value=nhd.d[e][1],nhd.edt=1+e),pwv()}};htype.innerHTML=sel([["Table",0],["Coord",1],["Pulse",2],["FMpoi",3],["Noise",15]]),hrate.innerHTML=sel([["8000",8e3],["11025",11025],["22050",22050],["32000",32e3],["44100",44100],["48000",48e3]]),hch.innerHTML=sel([["Mono",0],["Stereo",3],["L",1],["R",2]]),hbit.innerHTML=sel([["8 bit",8],["16 bit",16]]),htail.innerHTML=sel([["秒数ピッタリ",0],["周期ピッタリ",1],["1周期だけ",2],["必要最低限",3]]),hrate.value=44100,keybd(),fABC();let btn=0;window.addEventListener("mousedown",t=>{btn=t.buttons}),window.addEventListener("mouseup",t=>{btn=0,keyup()}),hDi.onmouseenter=t=>{0<btn&&(btn=0)},hDi.onmousemove=t=>msMov(t),hDi.onmousedown=t=>msMov(t);
